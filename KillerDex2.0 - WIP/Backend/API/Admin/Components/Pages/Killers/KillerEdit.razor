@page "/admin/killers/new"
@page "/admin/killers/{Id:guid}"
@attribute [Authorize]
@inject IKillerService KillerService
@inject IChapterService ChapterService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResource> L

<PageTitle>@(_isNew ? L["Killers_New"] : L["Killers_Edit"]) - KillerDex Admin</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Href="/admin/killers" />
    <MudText Typo="Typo.h4">@(_isNew ? L["Killers_New"] : $"{L["Common_Edit"]} {_model.Name}")</MudText>
</MudStack>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudForm @ref="_form" @bind-IsValid="_isValid">
        <MudGrid>
            <MudItem xs="12" md="8">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Form_BasicInformation"]</MudText>

                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_model.Name" Label="@L["Common_Name"]" Required="true"
                                          RequiredError="@string.Format(L["Common_Required"], L["Common_Name"])" MaxLength="100" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_model.RealName" Label="@L["Form_RealName"]" MaxLength="100" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Overview" Label="@L["Form_Overview"]" Lines="3" MaxLength="2000" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.Backstory" Label="@L["Form_Backstory"]" Lines="5" MaxLength="4000" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Form_Power"]</MudText>

                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_model.PowerName" Label="@L["Form_PowerName"]" Required="true"
                                          RequiredError="@string.Format(L["Common_Required"], L["Form_PowerName"])" MaxLength="100" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="_model.PowerDescription" Label="@L["Form_PowerDescription"]" Lines="3" MaxLength="2000" />
                        </MudItem>
                    </MudGrid>
                </MudPaper>

                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Form_Stats"]</MudText>

                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="_model.MovementSpeed" Label="@L["Form_MovementSpeed"]"
                                             Required="true" Min="0.01m" Max="10.0m" Step="0.01m" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudNumericField @bind-Value="_model.TerrorRadius" Label="@L["Form_TerrorRadius"]"
                                             Required="true" Min="0" Max="100" />
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudSelect @bind-Value="_model.Height" Label="@L["Form_Height"]" Required="true">
                                @foreach (var height in Enum.GetValues<KillerHeight>())
                                {
                                    <MudSelectItem Value="@height.ToString()">@height</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Form_MediaAndChapter"]</MudText>

                    <MudTextField @bind-Value="_model.ImageUrl" Label="@L["Form_ImageUrl"]" MaxLength="500" Class="mb-4" />

                    @if (!string.IsNullOrEmpty(_model.ImageUrl))
                    {
                        <MudImage Src="@_model.ImageUrl" Alt="Preview" Class="mb-4" Style="max-width: 100%; max-height: 200px;" ObjectFit="ObjectFit.Contain" />
                    }

                    <MudSelect @bind-Value="_model.ChapterId" Label="@L["Form_Chapter"]" Clearable="true" Class="mb-4">
                        @foreach (var chapter in _chapters)
                        {
                            <MudSelectItem Value="@chapter.Id">@chapter.Name</MudSelectItem>
                        }
                    </MudSelect>

                    <MudTextField @bind-Value="_model.GameVersion" Label="@L["Form_GameVersion"]" MaxLength="20" />
                </MudPaper>

                <MudPaper Class="pa-4 mt-4" Elevation="2">
                    <MudStack>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                   Disabled="@(!_isValid || _isSaving)" OnClick="Save">
                            @if (_isSaving)
                            {
                                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ms-2">@L["Common_Saving"]</MudText>
                            }
                            else
                            {
                                <MudText>@(_isNew ? L["Killers_Create"] : L["Common_SaveChanges"])</MudText>
                            }
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true" Href="/admin/killers">
                            @L["Common_Cancel"]
                        </MudButton>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudForm>
}

@code {
    [Parameter] public Guid? Id { get; set; }

    private MudForm? _form;
    private bool _isValid;
    private bool _isNew => !Id.HasValue;
    private bool _isLoading = true;
    private bool _isSaving;
    private List<ChapterSummaryDto> _chapters = new();

    private KillerFormModel _model = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _chapters = (await ChapterService.GetAllAsync()).ToList();

            if (Id.HasValue)
            {
                var killer = await KillerService.GetByIdAsync(Id.Value);
                if (killer != null)
                {
                    _model = new KillerFormModel
                    {
                        Name = killer.Name,
                        RealName = killer.RealName,
                        Overview = killer.Overview,
                        Backstory = killer.Backstory,
                        ImageUrl = killer.ImageUrl,
                        GameVersion = killer.GameVersion,
                        PowerName = killer.Power.Name,
                        PowerDescription = killer.Power.Description,
                        MovementSpeed = killer.MovementSpeed,
                        TerrorRadius = killer.TerrorRadius,
                        Height = killer.Height,
                        ChapterId = killer.Chapter?.Id
                    };
                }
            }
            else
            {
                _model = new KillerFormModel
                {
                    MovementSpeed = 4.6m,
                    TerrorRadius = 32,
                    Height = KillerHeight.Average.ToString()
                };
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task Save()
    {
        if (_form == null) return;
        await _form.Validate();
        if (!_isValid) return;

        _isSaving = true;
        try
        {
            if (_isNew)
            {
                var request = new CreateKillerRequest(
                    _model.Name,
                    _model.RealName,
                    _model.Overview,
                    _model.Backstory,
                    _model.ImageUrl,
                    _model.GameVersion,
                    new PowerRequest(_model.PowerName, _model.PowerDescription),
                    _model.MovementSpeed,
                    _model.TerrorRadius,
                    _model.Height,
                    _model.ChapterId
                );

                await KillerService.CreateAsync(request);
                Snackbar.Add(L["Common_CreateSuccess"], Severity.Success);
            }
            else
            {
                var request = new UpdateKillerRequest(
                    _model.Name,
                    _model.RealName,
                    _model.Overview,
                    _model.Backstory,
                    _model.ImageUrl,
                    _model.GameVersion,
                    new PowerRequest(_model.PowerName, _model.PowerDescription),
                    _model.MovementSpeed,
                    _model.TerrorRadius,
                    _model.Height,
                    _model.ChapterId
                );

                await KillerService.UpdateAsync(Id!.Value, request);
                Snackbar.Add(L["Common_UpdateSuccess"], Severity.Success);
            }

            Navigation.NavigateTo("/admin/killers");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{L["Common_Error"]}: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private class KillerFormModel
    {
        public string Name { get; set; } = string.Empty;
        public string? RealName { get; set; }
        public string? Overview { get; set; }
        public string? Backstory { get; set; }
        public string? ImageUrl { get; set; }
        public string? GameVersion { get; set; }
        public string PowerName { get; set; } = string.Empty;
        public string? PowerDescription { get; set; }
        public decimal MovementSpeed { get; set; }
        public int TerrorRadius { get; set; }
        public string Height { get; set; } = string.Empty;
        public Guid? ChapterId { get; set; }
    }
}
