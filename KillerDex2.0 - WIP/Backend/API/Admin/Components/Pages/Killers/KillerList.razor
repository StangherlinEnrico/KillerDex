@page "/admin/killers"
@attribute [Authorize]
@inject IKillerService KillerService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResource> L

<PageTitle>@L["Killers_PageTitle"]</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
    <MudText Typo="Typo.h4">@L["Nav_Killers"]</MudText>
    <MudSpacer />
    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/admin/killers/new">
        @L["Killers_Add"]
    </MudButton>
</MudStack>

<MudTable Items="@_filteredKillers" Dense="true" Hover="true" Striped="true" Loading="@_isLoading" LoadingProgressColor="Color.Primary">
    <ToolBarContent>
        <MudTextField @bind-Value="_searchString" Placeholder="@L["Common_SearchByName"]" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"
                      Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="FilterKillers" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh>@L["Common_Image"]</MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<KillerSummaryDto, object>(x => x.Name)">@L["Common_Name"]</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<KillerSummaryDto, object>(x => x.PowerName)">@L["Killers_Power"]</MudTableSortLabel></MudTh>
        <MudTh>@L["Common_Actions"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="@L["Common_Image"]">
            @if (!string.IsNullOrEmpty(context.ImageUrl))
            {
                <MudAvatar Size="Size.Medium">
                    <MudImage Src="@context.ImageUrl" Alt="@context.Name" />
                </MudAvatar>
            }
            else
            {
                <MudAvatar Color="Color.Primary" Size="Size.Medium">@context.Name[0]</MudAvatar>
            }
        </MudTd>
        <MudTd DataLabel="@L["Common_Name"]">@context.Name</MudTd>
        <MudTd DataLabel="@L["Killers_Power"]">@context.PowerName</MudTd>
        <MudTd DataLabel="@L["Common_Actions"]">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                           Href="@($"/admin/killers/{context.Id}")" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                           OnClick="@(() => DeleteKiller(context))" />
        </MudTd>
    </RowTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
    <NoRecordsContent>
        <MudText>@L["Killers_NoRecords"]</MudText>
    </NoRecordsContent>
</MudTable>

@code {
    private List<KillerSummaryDto> _killers = new();
    private IEnumerable<KillerSummaryDto> _filteredKillers = Enumerable.Empty<KillerSummaryDto>();
    private string _searchString = string.Empty;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadKillers();
    }

    private async Task LoadKillers()
    {
        _isLoading = true;
        try
        {
            _killers = (await KillerService.GetAllAsync()).ToList();
            FilterKillers();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterKillers()
    {
        if (string.IsNullOrWhiteSpace(_searchString))
        {
            _filteredKillers = _killers;
        }
        else
        {
            _filteredKillers = _killers.Where(k =>
                k.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
                k.PowerName.Contains(_searchString, StringComparison.OrdinalIgnoreCase));
        }
    }

    private async Task DeleteKiller(KillerSummaryDto killer)
    {
        var result = await DialogService.ShowMessageBox(
            L["Common_ConfirmDelete"],
            string.Format(L["Common_ConfirmDeleteMessage"], killer.Name),
            yesText: L["Common_Delete"],
            cancelText: L["Common_Cancel"]);

        if (result == true)
        {
            var success = await KillerService.DeleteAsync(killer.Id);
            if (success)
            {
                Snackbar.Add(string.Format(L["Common_DeleteSuccess"], killer.Name), Severity.Success);
                await LoadKillers();
            }
            else
            {
                Snackbar.Add(L["Common_DeleteFailed"], Severity.Error);
            }
        }
    }
}
